# PDF 렌더링 성능 비교 벤치마크

일반 PDF 렌더링 vs 우선순위 큐 기반 렌더링 성능을 비교하는 Puppeteer 벤치마크입니다.

## 🎯 측정 항목

### 1. PDF 렌더링 성능
- **총 렌더링 시간**: PDF가 화면에 렌더링되는 데 걸리는 시간
- **렌더링된 페이지 수**: 실제로 렌더링된 PDF 페이지 개수

### 2. 메인스레드 부하 ⭐
- **Long Tasks 수**: 50ms 이상 걸린 작업 개수 (메인스레드 블로킹 지표)
- **Total Blocking Time**: 메인스레드가 블로킹된 총 시간
- **Layout 횟수**: 레이아웃 재계산 횟수

> 💡 **우선순위 큐의 핵심 장점**: Long Tasks를 줄여 메인스레드 부하를 낮춥니다!

### 3. 메모리 사용량
- **JS Heap Used Size**: JavaScript 힙 메모리 사용량

### 4. 스크롤 성능 ⭐⭐
다양한 스크롤 시나리오에서 성능 측정:

#### 🌊 부드러운 스크롤 (Smooth Scroll)
- 5단계로 나눠서 천천히 스크롤
- 일반적인 사용자의 스크롤 패턴
- 약 2-3초 소요

#### ⚡ 빠른 스크롤 (Fast Scroll)
- 10단계로 나눠서 빠르게 연속 스크롤
- 급하게 내용을 찾는 상황 시뮬레이션
- 약 1.5-2초 소요

#### 🚀 점프 스크롤 (Jump Scroll)
- 페이지 전체를 급격하게 점프
- 특정 섹션으로 바로 이동하는 상황
- 약 1.5초 소요

각 시나리오에서 측정:
- **평균 FPS**: 스크롤 시 프레임 레이트
- **최소 FPS**: 가장 낮은 FPS (병목 지점)
- **드롭된 프레임**: 30 FPS 이하로 떨어진 프레임 수
- **60fps 미만 프레임**: 부드럽지 않은 프레임 수

## 🚀 사용 방법

### 1. 사전 준비

개발 서버가 실행 중이어야 합니다:

```bash
npm run dev
```

http://localhost:3000/feedback/4 페이지가 정상 작동하는지 확인하세요.

### 2. 벤치마크 실행

#### 방법 1: 셸 스크립트 사용 (권장)

```bash
# 실행 권한 부여 (최초 1회)
chmod +x bench/run-pdf-benchmark.sh

# 3회 실행 (기본값)
./bench/run-pdf-benchmark.sh

# 5회 실행
./bench/run-pdf-benchmark.sh 5

# 10회 실행 (더 정확한 통계)
./bench/run-pdf-benchmark.sh 10
```

#### 방법 2: 직접 실행

```bash
# 3회 실행
node bench/pdf-render-benchmark.js 3

# 5회 실행
node bench/pdf-render-benchmark.js 5
```

## 📊 출력 예시

```
================================================================================
🚀 PDF 렌더링 성능 비교 벤치마크
================================================================================

📊 설정:
   실행 횟수: 3회
   CPU 쓰로틀링: 4x
   대기 시간: 8000ms
   스크롤 테스트: 활성화

📊 테스트 중: PDF (일반)
URL: http://localhost:3000/feedback/4?version=pdf
  Run 1: PDF (일반)
    ✓ 완료 - 렌더링: 2547.32ms, 페이지: 3개
  Run 2: PDF (일반)
    ✓ 완료 - 렌더링: 2501.18ms, 페이지: 3개

📊 테스트 중: Queue (우선순위 큐)
URL: http://localhost:3000/feedback/4?version=queue
  Run 1: Queue (우선순위 큐)
    ✓ 완료 - 렌더링: 2103.45ms, 페이지: 3개

================================================================================
📊 성능 비교 결과
================================================================================

📄 PDF 렌더링 성능
--------------------------------------------------------------------------------
메트릭                              PDF (일반)               Queue (우선순위 큐)    
--------------------------------------------------------------------------------
총 렌더링 시간 (avg)                2524.25ms               2103.45ms             
렌더링된 페이지 수                   3개                     3개                   

⚡ 메인스레드 부하
--------------------------------------------------------------------------------
메트릭                              PDF (일반)               Queue (우선순위 큐)    
--------------------------------------------------------------------------------
Long Tasks 수 (>50ms)               47.3개                  28.7개                
Total Blocking Time                 823.42ms                512.34ms              
Layout 횟수                         156회                   98회                  

💾 메모리 사용량
--------------------------------------------------------------------------------
메트릭                              PDF (일반)               Queue (우선순위 큐)    
--------------------------------------------------------------------------------
JS Heap Used Size                   45.32MB                 41.28MB               

📈 스크롤 성능 - 전체 평균
--------------------------------------------------------------------------------
메트릭                              PDF (일반)               Queue (우선순위 큐)    
--------------------------------------------------------------------------------
평균 FPS                            52.3                    57.8                  
최소 FPS                            23.1                    31.4                  
드롭된 프레임 (<30 FPS)             12.0개                  5.0개                 
60fps 미만 프레임                   45.0개                  28.0개                

📊 스크롤 시나리오별 상세
--------------------------------------------------------------------------------

🌊 부드러운 스크롤 (5단계)
  메트릭                              PDF                 Queue               개선율
  평균 FPS                            54.2                58.3                ✅ 7.6%
  드롭된 프레임                       8개                 3개                 ✅ 62.5%

⚡ 빠른 스크롤 (10단계)
  메트릭                              PDF                 Queue               개선율
  평균 FPS                            48.9                55.1                ✅ 12.7%
  드롭된 프레임                       15개                7개                 ✅ 53.3%

🚀 점프 스크롤 (급격한 이동)
  메트릭                              PDF                 Queue               개선율
  평균 FPS                            53.8                60.1                ✅ 11.7%
  드롭된 프레임                       10개                5개                 ✅ 50.0%


================================================================================
🏆 우선순위 큐 개선율
================================================================================
✅ 렌더링 시간: +16.67%
✅ Long Tasks 감소: +39.32%
✅ Total Blocking Time 감소: +37.78%
✅ 메모리 사용량 감소: +8.91%
✅ 평균 FPS 향상: +10.51%
✅ 드롭 프레임 감소: +58.33%

--------------------------------------------------------------------------------
📊 개선된 메트릭: 6/6
📈 평균 개선율: +28.92%
--------------------------------------------------------------------------------

📁 결과 저장: bench_out/pdf-render-comparison-2025-10-13T23-45-30-123Z.json

✅ 벤치마크 완료!
```

## 🔧 설정 변경

`bench/pdf-render-benchmark.js` 파일의 `CONFIG` 객체에서 설정을 변경할 수 있습니다:

```javascript
const CONFIG = {
  baseUrl: 'http://localhost:3000/feedback/4',  // 테스트할 페이지
  runs: 3,              // 기본 실행 횟수
  waitAfterLoad: 8000,  // 페이지 로드 후 대기 시간 (ms)
  enableScroll: true,   // 스크롤 테스트 활성화 여부
  cpuThrottle: 4,       // CPU 쓰로틀링 (4배 느림)
  headless: true        // Headless 모드 (false로 하면 브라우저 보임)
};
```

## 📈 결과 해석

### 🎯 핵심 지표 이해하기

#### Long Tasks 수가 줄어들면?
- ✅ **메인스레드가 덜 블로킹됨**
- ✅ **사용자 인터랙션 응답성 향상**
- ✅ **부드러운 UI 경험**

#### Total Blocking Time이 줄어들면?
- ✅ **페이지가 더 빨리 인터랙티브해짐**
- ✅ **클릭, 스크롤 등의 반응 속도 향상**

#### 렌더링 시간이 줄어들면?
- ✅ **PDF가 더 빨리 화면에 표시됨**
- ✅ **초기 로딩 경험 개선**

### 📊 스크롤 시나리오별 의미

#### 🌊 부드러운 스크롤에서 개선되면?
- 일반적인 사용자 경험이 향상됨
- 페이지를 읽으면서 내리는 상황에서 부드러움

#### ⚡ 빠른 스크롤에서 개선되면?
- 급하게 내용을 찾을 때 부드러움
- **메인스레드 부하가 적다는 직접적 증거**
- 우선순위 큐가 빠른 스크롤 상황에서 특히 유리

#### 🚀 점프 스크롤에서 개선되면?
- 급격한 위치 변경 시 렌더링 성능 우수
- 뷰포트 변경에 빠르게 대응
- **렌더링 순서 제어의 효과**

### 🎖️ 왜 다양한 시나리오가 중요한가?

- **부드러운 스크롤**: 평소 사용성 (가장 흔한 케이스)
- **빠른 스크롤**: 부하가 높은 상황 (차이가 가장 크게 남)
- **점프 스크롤**: 우선순위 큐의 순서 제어 능력 테스트

→ **세 가지 모두 개선되면 우선순위 큐가 확실히 우수함을 증명!**

## 📂 출력 파일

결과는 `bench_out/` 디렉토리에 JSON 형식으로 저장됩니다:

```
bench_out/
  ├── pdf-render-comparison-2025-10-13T23-45-30-123Z.json
  └── ...
```

JSON 파일에는 다음 정보가 포함됩니다:
- 원본 측정 데이터
- 통계 (평균, 최소, 최대, 중앙값)
- 개선율 계산 결과

## 🐛 문제 해결

### "Cannot connect to Chrome" 에러
```bash
# Puppeteer Chrome 재설치
npm install puppeteer --force
```

### 페이지가 로드되지 않음
- 개발 서버(`npm run dev`)가 실행 중인지 확인
- http://localhost:3000/feedback/4 페이지에 직접 접속해서 확인

### 측정값이 0 또는 N/A
- `waitAfterLoad` 시간을 늘려보세요 (예: 10000ms)
- PDF 파일이 실제로 로드되는지 확인

### Headless 모드에서 디버깅
```javascript
// CONFIG에서 headless를 false로 변경
headless: false  // 브라우저가 눈에 보이게 실행됨
```

## 💡 팁

1. **여러 번 실행하기**: 최소 3회 이상 실행해서 평균을 내는 것이 정확합니다.
   ```bash
   ./bench/run-pdf-benchmark.sh 5  # 5회 실행
   ```

2. **다른 프로그램 종료**: 벤치마크 실행 중에는 다른 무거운 프로그램을 종료하세요.

3. **CPU 쓰로틀링**: 실제 사용자 환경을 시뮬레이션하기 위해 CPU 쓰로틀링을 사용합니다.
   - 4x = 일반 모바일 환경
   - 2x = 저사양 노트북
   - 1x = 고사양 환경

4. **결과 비교**: 여러 버전의 결과를 저장해두고 비교하세요.

5. **스크롤 시나리오 주목**: 빠른 스크롤에서 차이가 가장 크게 나타납니다!
   - 이 지표가 우선순위 큐의 메인스레드 부하 감소를 증명합니다.

6. **긴 테스트 시간**: 전체 벤치마크는 약 40-50초 소요됩니다.
   - PDF 로딩: 8초 x 2 버전
   - 스크롤 테스트: 각 10초 x 2 버전
   - 여러 번 실행 시 더 오래 걸림

